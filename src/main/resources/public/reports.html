<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Berichte - Website Analyzer</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div class="container header-content">
    <div class="logo">
      <img src="images/logo.png" alt="Saraci Design Logo">
      <div class="logo-text">
        <h1>Website Analyzer</h1>
        <p>Berichte</p>
      </div>
    </div>
  </div>
</header>

<nav>
  <div class="container">
    <div class="nav-container">
      <a href="/" class="nav-link">Analyse-Tool</a>
      <a href="/dashboard.html" class="nav-link">Dashboard</a>
      <a href="/leads.html" class="nav-link">Leads</a>
      <a href="/email.html" class="nav-link">E-Mail-Generator</a>
      <a href="/reports.html" class="nav-link active">Berichte</a>
      <a href="/settings.html" class="nav-link">Einstellungen</a>
    </div>
  </div>
</nav>

<div class="main-content">
  <div class="container">
    <div id="alertContainer"></div>

    <!-- Filteroption und Suchleiste -->
    <div class="reports-header">
      <div class="search-filter">
        <input type="text" id="searchInput" placeholder="Berichte durchsuchen..." class="search-input">
        <select id="leadFilter" class="filter-select">
          <option value="all">Alle Leads</option>
          <!-- Leads werden hier per JavaScript eingefügt -->
        </select>
        <select id="dateFilter" class="filter-select">
          <option value="all">Alle Daten</option>
          <option value="today">Heute</option>
          <option value="yesterday">Gestern</option>
          <option value="week">Diese Woche</option>
          <option value="month">Diesen Monat</option>
          <option value="year">Dieses Jahr</option>
        </select>
      </div>
    </div>

    <!-- Berichte-Liste -->
    <div class="card">
      <div class="card-header">
        <h2>Berichte-Archiv</h2>
        <div class="header-actions">
          <button id="bulkDownloadBtn" class="btn btn-secondary btn-sm" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Ausgewählte herunterladen
          </button>
          <button id="bulkDeleteBtn" class="btn btn-secondary btn-sm" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            Ausgewählte löschen
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="loader-container" id="loader" style="display: none;">
          <div class="loader"></div>
          <p>Berichte werden geladen...</p>
        </div>

        <div class="table-container">
          <table id="reportsTable">
            <thead>
            <tr>
              <th>
                <input type="checkbox" id="selectAllReports">
              </th>
              <th>Lead</th>
              <th>Berichtsname</th>
              <th>Datum</th>
              <th>Typ</th>
              <th>Dateigröße</th>
              <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            <!-- Berichte werden hier per JavaScript eingefügt -->
            </tbody>
          </table>
        </div>

        <div id="emptyReportsMessage" style="display: none; text-align: center; padding: 30px;">
          <p>Keine Berichte gefunden. Analysiere eine Website, um einen Bericht zu erstellen!</p>
          <a href="/" class="btn" style="margin-top: 15px;">Website analysieren</a>
        </div>

        <div class="pagination" id="reportsPagination">
          <!-- Paginierung wird hier per JavaScript eingefügt -->
        </div>
      </div>
    </div>

    <!-- Bericht-Details Modal -->
    <div id="reportDetailsModal" class="modal">
      <div class="modal-content modal-lg">
        <div class="modal-header">
          <h2 id="reportDetailTitle">Berichtsdetails</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="report-details-container">
            <div class="report-sidebar">
              <div class="pdf-preview" id="pdfPreview">
                <!-- PDF-Vorschau wird hier per JavaScript eingefügt -->
                <div class="pdf-placeholder">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                  <p>PDF-Vorschau nicht verfügbar</p>
                </div>
              </div>
              <div class="report-actions">
                <a id="downloadReportBtn" href="#" class="btn btn-block" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                  PDF herunterladen
                </a>
                <button id="shareReportBtn" class="btn btn-secondary btn-block">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                  Per E-Mail teilen
                </button>
                <button id="deleteReportBtn" class="btn btn-secondary btn-block">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                  Bericht löschen
                </button>
              </div>
            </div>
            <div class="report-info">
              <div class="report-meta">
                <div class="meta-item">
                  <div class="meta-label">Lead:</div>
                  <div class="meta-value" id="reportLead">-</div>
                </div>
                <div class="meta-item">
                  <div class="meta-label">Berichtsname:</div>
                  <div class="meta-value" id="reportName">-</div>
                </div>
                <div class="meta-item">
                  <div class="meta-label">Erstellt am:</div>
                  <div class="meta-value" id="reportDate">-</div>
                </div>
                <div class="meta-item">
                  <div class="meta-label">Typ:</div>
                  <div class="meta-value" id="reportType">-</div>
                </div>
                <div class="meta-item">
                  <div class="meta-label">Dateigröße:</div>
                  <div class="meta-value" id="reportSize">-</div>
                </div>
                <div class="meta-item">
                  <div class="meta-label">URL:</div>
                  <div class="meta-value" id="reportUrl">-</div>
                </div>
              </div>

              <div class="report-summary-container">
                <h3>Zusammenfassung</h3>
                <div class="report-scores">
                  <div class="score-item">
                    <div class="score-circle success">
                      <div class="score-value" id="reportSeoScore">-</div>
                    </div>
                    <div class="score-label">SEO</div>
                  </div>
                  <div class="score-item">
                    <div class="score-circle warning">
                      <div class="score-value" id="reportPerfScore">-</div>
                    </div>
                    <div class="score-label">Performance</div>
                  </div>
                  <div class="score-item">
                    <div class="score-circle error">
                      <div class="score-value" id="reportSecScore">-</div>
                    </div>
                    <div class="score-label">Sicherheit</div>
                  </div>
                </div>

                <div class="report-findings">
                  <h4>Wichtigste Erkenntnisse</h4>
                  <ul id="reportFindings">
                    <!-- Erkenntnisse werden hier per JavaScript eingefügt -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Teilen Modal -->
    <div id="shareModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Bericht teilen</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="shareForm">
            <div class="form-group">
              <label for="shareRecipients">Empfänger*</label>
              <input type="text" id="shareRecipients" name="recipients" required>
              <span class="input-hint">Mehrere E-Mail-Adressen durch Komma trennen</span>
            </div>
            <div class="form-group">
              <label for="shareSubject">Betreff</label>
              <input type="text" id="shareSubject" name="subject" required>
            </div>
            <div class="form-group">
              <label for="shareMessage">Nachricht</label>
              <textarea id="shareMessage" name="message" rows="4"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">Senden</button>
              <button type="button" id="cancelShareBtn" class="btn btn-secondary">Abbrechen</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container footer-content">
    <div class="footer-text">
      &copy; 2025 Saraci Design. Alle Rechte vorbehalten.
    </div>
    <div class="footer-links">
      <a href="/">Analyse-Tool</a>
      <a href="/dashboard.html">Dashboard</a>
      <a href="/leads.html">Leads</a>
      <a href="/email.html">E-Mail-Generator</a>
      <a href="/reports.html">Berichte</a>
      <a href="/settings.html">Einstellungen</a>
      <a href="https://saraci-design.de" target="_blank">Saraci Design</a>
    </div>
  </div>
</footer>

<script src="js/utils.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM-Elemente
    const reportsTable = document.getElementById('reportsTable').querySelector('tbody');
    const emptyReportsMessage = document.getElementById('emptyReportsMessage');
    const loader = document.getElementById('loader');
    const searchInput = document.getElementById('searchInput');
    const leadFilter = document.getElementById('leadFilter');
    const dateFilter = document.getElementById('dateFilter');
    const reportsPagination = document.getElementById('reportsPagination');

    // Checkboxen und Bulk-Aktionen
    const selectAllReports = document.getElementById('selectAllReports');
    const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

    // Bericht-Details Modal
    const reportDetailsModal = document.getElementById('reportDetailsModal');
    const reportDetailTitle = document.getElementById('reportDetailTitle');
    const pdfPreview = document.getElementById('pdfPreview');
    const downloadReportBtn = document.getElementById('downloadReportBtn');
    const shareReportBtn = document.getElementById('shareReportBtn');
    const deleteReportBtn = document.getElementById('deleteReportBtn');

    // Bericht-Meta-Informationen
    const reportLead = document.getElementById('reportLead');
    const reportName = document.getElementById('reportName');
    const reportDate = document.getElementById('reportDate');
    const reportType = document.getElementById('reportType');
    const reportSize = document.getElementById('reportSize');
    const reportUrl = document.getElementById('reportUrl');

    // Bericht-Scores
    const reportSeoScore = document.getElementById('reportSeoScore');
    const reportPerfScore = document.getElementById('reportPerfScore');
    const reportSecScore = document.getElementById('reportSecScore');
    const reportFindings = document.getElementById('reportFindings');

    // Teilen Modal
    const shareModal = document.getElementById('shareModal');
    const shareForm = document.getElementById('shareForm');
    const shareRecipients = document.getElementById('shareRecipients');
    const shareSubject = document.getElementById('shareSubject');
    const shareMessage = document.getElementById('shareMessage');
    const cancelShareBtn = document.getElementById('cancelShareBtn');

    // Paginierung
    let currentPage = 1;
    let totalPages = 1;
    const itemsPerPage = 10;

    // Aktueller Bericht für Aktionen
    let currentReport = null;

    // Lade Berichte und Leads beim Seitenaufruf
    loadReports();
    loadLeads();

    // Event-Listener für Suche und Filter
    searchInput.addEventListener('input', filterReports);
    leadFilter.addEventListener('change', filterReports);
    dateFilter.addEventListener('change', filterReports);

    // Event-Listener für "Alle auswählen" Checkbox
    selectAllReports.addEventListener('change', function() {
      const checkboxes = reportsTable.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });

      updateBulkActionButtons();
    });

    // Event-Listener für Bulk-Aktionen
    bulkDownloadBtn.addEventListener('click', bulkDownload);
    bulkDeleteBtn.addEventListener('click', bulkDelete);

    // Event-Listener für Bericht-Aktionen
    shareReportBtn.addEventListener('click', openShareModal);
    deleteReportBtn.addEventListener('click', deleteCurrentReport);

    // Event-Listener für Teilen-Modal
    shareForm.addEventListener('submit', shareReport);
    cancelShareBtn.addEventListener('click', () => shareModal.style.display = 'none');

    // Event-Listener für Modal-Schließen
    document.querySelectorAll('.close').forEach(closeBtn => {
      closeBtn.addEventListener('click', function() {
        reportDetailsModal.style.display = 'none';
        shareModal.style.display = 'none';
      });
    });

    // Funktion zum Laden aller Berichte
    async function loadReports() {
      loader.style.display = 'block';
      reportsTable.innerHTML = '';
      emptyReportsMessage.style.display = 'none';

      try {
        // API-Anfrage mit Paginierung
        const reports = await apiRequest(`/reports?page=${currentPage}&limit=${itemsPerPage}`);

        if (reports.items.length === 0) {
          emptyReportsMessage.style.display = 'block';
        } else {
          displayReports(reports.items);

          // Paginierung aktualisieren
          totalPages = Math.ceil(reports.total / itemsPerPage);
          updatePagination();
        }
      } catch (error) {
        showAlert(error.message || 'Fehler beim Laden der Berichte', 'error');
      } finally {
        loader.style.display = 'none';
      }
    }

    // Funktion zum Laden aller Leads für den Filter
    async function loadLeads() {
      try {
        const leads = await apiRequest('/leads');

        // Leads zum Filter hinzufügen
        leads.forEach(lead => {
          const option = document.createElement('option');
          option.value = lead.id;
          option.textContent = lead.companyName;
          leadFilter.appendChild(option);
        });
      } catch (error) {
        console.error('Fehler beim Laden der Leads:', error);
      }
    }

    // Funktion zum Anzeigen der Berichte in der Tabelle
    function displayReports(reports) {
      reportsTable.innerHTML = '';

      reports.forEach(report => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>
            <input type="checkbox" class="report-checkbox" data-id="${report.id}">
          </td>
          <td>${report.leadName || '-'}</td>
          <td>${report.name || 'Website-Analyse'}</td>
          <td>${formatDate(report.createdAt)}</td>
          <td>${getReportTypeLabel(report.type)}</td>
          <td>${formatFileSize(report.fileSize)}</td>
          <td>
            <button class="btn-icon view-report" title="Details anzeigen">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
            <a href="${report.pdfPath}" class="btn-icon download-report" title="Herunterladen" target="_blank">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </a>
            <button class="btn-icon delete-report" title="Löschen">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </td>
        `;

        // Event-Listener für Aktionen
        row.querySelector('.view-report').addEventListener('click', () => openReportDetails(report.id));
        row.querySelector('.delete-report').addEventListener('click', () => {
          if (confirm(`Möchtest du den Bericht "${report.name || 'Website-Analyse'}" wirklich löschen?`)) {
            deleteReport(report.id);
          }
        });

        // Event-Listener für Checkboxen
        row.querySelector('.report-checkbox').addEventListener('change', updateBulkActionButtons);

        reportsTable.appendChild(row);
      });
    }

    // Funktion zum Aktualisieren der Paginierung
    function updatePagination() {
      reportsPagination.innerHTML = '';

      if (totalPages <= 1) {
        return;
      }

      const createPageButton = (pageNum, text, isActive = false, isDisabled = false) => {
        const button = document.createElement('button');
        button.className = `pagination-button ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
        button.textContent = text;

        if (!isDisabled) {
          button.addEventListener('click', () => {
            currentPage = pageNum;
            loadReports();
          });
        }

        return button;
      };

      // Erste Seite Button
      reportsPagination.appendChild(
        createPageButton(1, '«', false, currentPage === 1)
      );

      // Vorherige Seite Button
      reportsPagination.appendChild(
        createPageButton(currentPage - 1, '‹', false, currentPage === 1)
      );

      // Seitenzahlen
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);

      for (let i = startPage; i <= endPage; i++) {
        reportsPagination.appendChild(
          createPageButton(i, i.toString(), i === currentPage)
        );
      }

      // Nächste Seite Button
      reportsPagination.appendChild(
        createPageButton(currentPage + 1, '›', false, currentPage === totalPages)
      );

      // Letzte Seite Button
      reportsPagination.appendChild(
        createPageButton(totalPages, '»', false, currentPage === totalPages)
      );
    }

    // Funktion zum Filtern der Berichte
    function filterReports() {
      const searchTerm = searchInput.value.toLowerCase();
      const leadId = leadFilter.value;
      const dateValue = dateFilter.value;

      // Verberge die leeren Berichte Nachricht während der Filterung
      emptyReportsMessage.style.display = 'none';

      // Alle Zeilen durchgehen
      const rows = reportsTable.querySelectorAll('tr');
      let visibleCount = 0;

      rows.forEach(row => {
        const leadName = row.cells[1].textContent.toLowerCase();
        const reportName = row.cells[2].textContent.toLowerCase();
        const reportDate = row.cells[3].textContent;
        const reportType = row.cells[4].textContent.toLowerCase();

        // Prüfen, ob die Zeile dem Suchbegriff entspricht
        const matchesSearch =
          leadName.includes(searchTerm) ||
          reportName.includes(searchTerm) ||
          reportType.includes(searchTerm);

        // Prüfen, ob die Zeile dem Lead-Filter entspricht
        const matchesLead = leadId === 'all' || row.querySelector('.report-checkbox').getAttribute('data-lead-id') === leadId;

        // Prüfen, ob die Zeile dem Datumsfilter entspricht
        const matchesDate = matchesDateFilter(reportDate, dateValue);

        // Zeile anzeigen oder ausblenden
        if (matchesSearch && matchesLead && matchesDate) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      // Nachricht anzeigen, wenn keine Berichte gefunden wurden
      if (visibleCount === 0 && rows.length > 0) {
        emptyReportsMessage.style.display = 'block';
        emptyReportsMessage.querySelector('p').textContent = 'Keine Berichte gefunden, die den Filterkriterien entsprechen.';
      }
    }

    // Hilfsfunktion zum Prüfen des Datumsfilters
    function matchesDateFilter(dateString, filterValue) {
      if (filterValue === 'all') return true;

      const reportDate = new Date(dateString);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      switch (filterValue) {
        case 'today':
          return reportDate >= today;
        case 'yesterday':
          return reportDate >= yesterday && reportDate < today;
        case 'week':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          return reportDate >= weekStart;
        case 'month':
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          return reportDate >= monthStart;
        case 'year':
          const yearStart = new Date(today.getFullYear(), 0, 1);
          return reportDate >= yearStart;
        default:
          return true;
      }
    }

    // Funktion zum Aktualisieren der Bulk-Action-Buttons
    function updateBulkActionButtons() {
      const checkedCheckboxes = reportsTable.querySelectorAll('input[type="checkbox"]:checked');
      const isAnyChecked = checkedCheckboxes.length > 0;

      bulkDownloadBtn.disabled = !isAnyChecked;
      bulkDeleteBtn.disabled = !isAnyChecked;

      // "Alle auswählen" Checkbox aktualisieren
      const allCheckboxes = reportsTable.querySelectorAll('input[type="checkbox"]');
      selectAllReports.checked = checkedCheckboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
    }

    // Funktion zum Öffnen der Bericht-Details
    async function openReportDetails(reportId) {
      try {
        // Bericht-Daten laden
        const report = await apiRequest(`/reports/${reportId}`);
        currentReport = report;

        // Modal-Titel setzen
        reportDetailTitle.textContent = report.name || 'Website-Analyse';

        // Bericht-Details anzeigen
        displayReportDetails(report);

        // Download-Link aktualisieren
        downloadReportBtn.href = report.pdfPath;

        // Modal anzeigen
        reportDetailsModal.style.display = 'block';
      } catch (error) {
        showAlert(error.message || 'Fehler beim Laden der Bericht-Details', 'error');
      }
    }

    // Funktion zum Anzeigen der Bericht-Details
    function displayReportDetails(report) {
      // Meta-Informationen
      reportLead.textContent = report.leadName || '-';
      reportName.textContent = report.name || 'Website-Analyse';
      reportDate.textContent = formatDate(report.createdAt);
      reportType.textContent = getReportTypeLabel(report.type);
      reportSize.textContent = formatFileSize(report.fileSize);
      reportUrl.textContent = report.url || '-';

      // Scores
      reportSeoScore.textContent = report.scores?.seo || '-';
      reportPerfScore.textContent = report.scores?.performance || '-';
      reportSecScore.textContent = report.scores?.security || '-';

      // Erkenntnisse
      reportFindings.innerHTML = '';
      if (report.findings && report.findings.length > 0) {
        report.findings.forEach(finding => {
          const li = document.createElement('li');
          li.textContent = finding;
          reportFindings.appendChild(li);
        });
      } else {
        reportFindings.innerHTML = '<li>Keine detaillierten Erkenntnisse verfügbar.</li>';
      }

      // PDF-Vorschau
      if (report.pdfPath) {
        pdfPreview.innerHTML = `
          <iframe src="${report.pdfPath}" width="100%" height="100%" frameborder="0"></iframe>
        `;
      } else {
        pdfPreview.innerHTML = `
          <div class="pdf-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            <p>PDF-Vorschau nicht verfügbar</p>
          </div>
        `;
      }

      // Teilen-Modal vorbereiten
      shareSubject.value = `Website-Analyse: ${report.url || 'Website'}`;
      shareMessage.value = `Hallo,\n\nanbei erhalten Sie eine Website-Analyse für ${report.url || 'Ihre Website'}.\n\nMit freundlichen Grüßen`;
    }

    // Funktion zum Löschen eines Berichts
    async function deleteReport(id) {
      try {
        await apiRequest(`/reports/${id}`, 'DELETE');
        showAlert('Bericht erfolgreich gelöscht', 'success');
        loadReports();
      } catch (error) {
        showAlert(error.message || 'Fehler beim Löschen des Berichts', 'error');
      }
    }

    // Funktion zum Löschen des aktuellen Berichts
    async function deleteCurrentReport() {
      if (!currentReport) {
        showAlert('Kein Bericht ausgewählt', 'warning');
        return;
      }

      if (confirm(`Möchtest du den Bericht "${currentReport.name || 'Website-Analyse'}" wirklich löschen?`)) {
        try {
          await apiRequest(`/reports/${currentReport.id}`, 'DELETE');

          // Modal schließen
          reportDetailsModal.style.display = 'none';

          showAlert('Bericht erfolgreich gelöscht', 'success');
          loadReports();
        } catch (error) {
          showAlert(error.message || 'Fehler beim Löschen des Berichts', 'error');
        }
      }
    }

    // Funktion zum Herunterladen mehrerer Berichte
    async function bulkDownload() {
      const checkedCheckboxes = reportsTable.querySelectorAll('input[type="checkbox"]:checked');

      if (checkedCheckboxes.length === 0) {
        showAlert('Keine Berichte ausgewählt', 'warning');
        return;
      }

      // Sammle alle ausgewählten Bericht-IDs
      const reportIds = Array.from(checkedCheckboxes).map(checkbox => checkbox.getAttribute('data-id'));

      try {
        // API-Anfrage zum Herunterladen mehrerer Berichte
        const response = await apiRequest('/reports/download-multiple', 'POST', { reportIds });

        // ZIP-Datei herunterladen
        window.location.href = response.zipPath;

        showAlert('Download gestartet', 'success');
      } catch (error) {
        showAlert(error.message || 'Fehler beim Herunterladen der Berichte', 'error');
      }
    }

    // Funktion zum Löschen mehrerer Berichte
    async function bulkDelete() {
      const checkedCheckboxes = reportsTable.querySelectorAll('input[type="checkbox"]:checked');

      if (checkedCheckboxes.length === 0) {
        showAlert('Keine Berichte ausgewählt', 'warning');
        return;
      }

      if (confirm(`Möchtest du ${checkedCheckboxes.length} Berichte wirklich löschen?`)) {
        // Sammle alle ausgewählten Bericht-IDs
        const reportIds = Array.from(checkedCheckboxes).map(checkbox => checkbox.getAttribute('data-id'));

        try {
          // API-Anfrage zum Löschen mehrerer Berichte
          await apiRequest('/reports/delete-multiple', 'POST', { reportIds });

          showAlert('Berichte erfolgreich gelöscht', 'success');
          loadReports();
        } catch (error) {
          showAlert(error.message || 'Fehler beim Löschen der Berichte', 'error');
        }
      }
    }

    // Funktion zum Öffnen des Teilen-Modals
    function openShareModal() {
      if (!currentReport) {
        showAlert('Kein Bericht ausgewählt', 'warning');
        return;
      }

      // Modal anzeigen
      shareModal.style.display = 'block';
    }

    // Funktion zum Teilen eines Berichts per E-Mail
    async function shareReport(e) {
      e.preventDefault();

      if (!currentReport) {
        showAlert('Kein Bericht ausgewählt', 'warning');
        return;
      }

      // Daten aus dem Formular sammeln
      const shareData = {
        reportId: currentReport.id,
        recipients: shareRecipients.value,
        subject: shareSubject.value,
        message: shareMessage.value
      };

      try {
        // API-Anfrage zum Teilen des Berichts
        await apiRequest('/reports/share', 'POST', shareData);

        // Modal schließen
        shareModal.style.display = 'none';

        showAlert('Bericht erfolgreich geteilt', 'success');
      } catch (error) {
        showAlert(error.message || 'Fehler beim Teilen des Berichts', 'error');
      }
    }

    // Hilfsfunktion: Berichtstyp-Label ermitteln
    function getReportTypeLabel(type) {
      switch (type) {
        case 'full': return 'Vollständig';
        case 'seo': return 'SEO';
        case 'performance': return 'Performance';
        case 'security': return 'Sicherheit';
        default: return type || 'Vollständig';
      }
    }

    // Hilfsfunktion: Dateigröße formatieren
    function formatFileSize(bytes) {
      if (bytes === 0 || bytes === undefined || bytes === null) return '0 Bytes';

      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Schließe Modals beim Klicken außerhalb
    window.addEventListener('click', function(event) {
      if (event.target === reportDetailsModal) {
        reportDetailsModal.style.display = 'none';
      } else if (event.target === shareModal) {
        shareModal.style.display = 'none';
      }
    });
  });
</script>

<style>
  /* Zusätzliche Styles für die Berichte-Seite */
  .reports-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .search-filter {
    display: flex;
    gap: 10px;
    width: 100%;
  }

  .search-input {
    flex: 1;
  }

  .filter-select {
    width: 180px;
  }

  .header-actions {
    display: flex;
    gap: 10px;
  }

  .btn-sm {
    padding: 8px 12px;
    font-size: 0.8rem;
  }

  .btn-sm svg {
    margin-right: 5px;
    vertical-align: middle;
  }

  .btn-icon {
    background: none;
    border: none;
    color: var(--text-color-secondary);
    padding: 5px;
    cursor: pointer;
    border-radius: 4px;
    transition: color 0.3s, background-color 0.3s;
  }

  .btn-icon:hover {
    color: var(--accent-color);
    background-color: rgba(255, 255, 255, 0.05);
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    overflow: auto;
  }

  .modal-content {
    background-color: var(--card-color);
    margin: 10vh auto;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    animation: modalFadeIn 0.3s;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }

  .modal-lg {
    max-width: 900px;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .close {
    font-size: 24px;
    font-weight: bold;
    color: var(--text-color-secondary);
    cursor: pointer;
  }

  .close:hover {
    color: var(--accent-color);
  }

  .modal-body {
    padding: 20px;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }

  .report-details-container {
    display: flex;
    gap: 30px;
  }

  .report-sidebar {
    flex: 0 0 300px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .report-info {
    flex: 1;
  }

  .pdf-preview {
    height: 400px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
    background-color: #f0f0f0;
  }

  .pdf-preview iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .pdf-placeholder {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #888;
    background-color: rgba(255, 255, 255, 0.05);
  }

  .pdf-placeholder svg {
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .report-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .btn-block {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-block svg {
    margin-right: 8px;
  }

  .report-meta {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }

  .meta-item {
    background-color: rgba(255, 255, 255, 0.03);
    padding: 12px 15px;
    border-radius: 6px;
  }

  .meta-label {
    font-size: 0.75rem;
    color: var(--text-color-secondary);
    margin-bottom: 5px;
  }

  .meta-value {
    font-size: 0.95rem;
    word-break: break-word;
  }

  .report-summary-container {
    margin-top: 30px;
  }

  .report-summary-container h3 {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }

  .report-scores {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }

  .score-item {
    text-align: center;
    margin: 0 10px 20px;
  }

  .report-findings {
    background-color: rgba(255, 255, 255, 0.03);
    padding: 20px;
    border-radius: 6px;
    margin-top: 20px;
  }

  .report-findings h4 {
    margin-top: 0;
    margin-bottom: 15px;
  }

  .report-findings ul {
    margin: 0;
    padding-left: 20px;
  }

  .report-findings li {
    margin-bottom: 10px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 30px;
  }

  .pagination-button {
    padding: 8px 12px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .pagination-button:hover:not(.disabled) {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .pagination-button.active {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
  }

  .pagination-button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 992px) {
    .report-details-container {
      flex-direction: column;
    }

    .report-sidebar {
      flex: 0 0 auto;
      width: 100%;
    }

    .pdf-preview {
      height: 300px;
    }
  }

  @media (max-width: 768px) {
    .search-filter {
      flex-direction: column;
    }

    .header-actions {
      flex-direction: column;
      margin-top: 10px;
    }

    .report-meta {
      grid-template-columns: 1fr;
    }
  }
</style>